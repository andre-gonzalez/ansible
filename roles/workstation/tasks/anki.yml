---
- name: Ensure anki directory exists.
  tags:
    - full-install
    - light-install
    - anki
  ansible.builtin.file:
    dest: "{{ lookup('env', 'HOME') }}/.config/anki/install-files"
    mode: 0700
    state: directory

- name: Get latest anki release
  tags:
    - full-install
    - light-install
    - anki
  ansible.builtin.uri:
    url: https://api.github.com/repos/ankitects/anki/releases/latest
    return_content: true
  register: json_reponse

- name: Download anki installer
  tags:
    - full-install
    - light-install
    - anki
  ansible.builtin.get_url:
    url: "{{ json_reponse.json.assets.2.browser_download_url }}"
    dest: "{{ lookup('env', 'HOME') }}/.config/anki/anki-installer.tar.zst"
    force: true
    mode: 0777
  register: "proceed_anki_installation"

- name: Extract anki files
  tags:
    - full-install
    - light-install
    - anki
  ansible.builtin.unarchive:
    src: "{{ lookup('env', 'HOME') }}/.config/anki/anki-installer.tar.zst"
    dest: "{{ lookup('env', 'HOME') }}/.config/anki/install-files"
  when: proceed_anki_installation is changed

- name: Install anki
  tags:
    - full-install
    - light-install
    - anki
  ansible.builtin.script:
    chdir: "{{ lookup('env', 'HOME') }}/.config/anki/install-files/{{ json_reponse.json.assets.2.name | regex_replace( '\\.\\w*\\.\\w*$', '')  }}"
    cmd: "{{ lookup('env', 'HOME') }}/.config/anki/install-files/{{ json_reponse.json.assets.2.name | regex_replace( '\\.\\w*\\.\\w*$', '')  }}/install.sh"
  become: true
  when: proceed_anki_installation is changed
