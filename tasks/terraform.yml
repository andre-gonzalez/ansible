---
- name: Terraform archive-keyring.gpg download
  tags:
    - full-install
    - light-install
    - terraform
  ansible.builtin.get_url:
    url: terraform.gpg https://apt.releases.hashicorp.com/gpg
    dest: /usr/share/keyrings/terraform-archive-keyring.gpg
  become: true
  when: ansible_distribution in ["Ubuntu", "Debian"]

- name: Terraform PPA setting
  tags:
    - full-install
    - light-install
    - terraform
  ansible.builtin.shell: echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/terraform-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" > /etc/apt/sources.list.d/terraform.list
  become: true
  when: ansible_distribution in ["Ubuntu", "Debian"]

- name: Terraform apt installation
  tags:
    - full-install
    - light-install
    - terraform
  ansible.builtin.package:
    name: terraform
    update_cache: true
  become: true
  when: ansible_distribution in ["Ubuntu", "Debian"]

- name: Install Terraform package
  tags:
    - full-install
    - light-install
    - terraform
  ansible.builtin.package:
    name:
      - terraform
    state: present
    update_cache: true
  become: true
  when: ansible_distribution == "Archlinux"

- name: Install terraform language server
  tags:
    - aur
    - neovim
    - terraform
  kewlfft.aur.aur:
    name:
      - terraform-ls
    use: yay
    state: present
    update_cache: true
  when: ansible_distribution == "Archlinux"
  ignore_errors: true

- name: Install treesitter support for HCL (Terraform language)
  tags:
    - full-install
    - light-install
    - neovim
    - terraform
  ansible.builtin.command: nvim --headless +TSInstall hcl +qa
